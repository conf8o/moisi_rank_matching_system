# マッチングシステムの概要

## 背景

天下一モイシランクでは、内部レートの近い同士でマッチングするようにしたい。

パーティの場合、3人の内部レートの平均をパーティの内部レートとして、マッチングに参加する。

内部レートの計算方法は、モイシランクの初期段階ではRealmで採用されているような個人に付与されるポイントを利用する。

ただし内部レートの計算方法は、今後とも検討の余地があり、運営や開発者で相談して決めていきたい。


## このドキュメントが述べる内容の決定度

「提案」程度

## 内容

### 忙しい人用

* できるだけポイントの近いプレイヤー達をマッチに入れる。
* それでも、その中で強い人弱い人が含まれるのは避けられない。
* テキトーにパーティを作ると強いパーティと弱いパーティが生まれる可能性がある。
* できるだけ平等なマッチングを行うロジックが必要。
  * 弱いデュオには強いソロを割り当てる。
  * 強いデュオには弱いソロを割り当てる。
  * ソロ同士では[弱、中、強]、または「中、中、中」となるようにパーティを作る。

下記より、詳細を説明する。

### 平等なマッチングシステムとは

下記の例では、マッチに参加するパーティの組み合わせの例を挙げ、その良し悪しを考える。20パーティだと多いので、3パーティで考える

例: 参加するパーティとプレイヤーの内部レートのリスト

1. [[4, 5, 6], [5, 5, 5], [4, 7, 7]]
2. [[1, 2, 3], [13, 15, 20], [4, 7, 10]]
3. [[2, 10, 12], [8, 8, 8], [16, 4, 4]]

このうち2.のマッチングはひと目で最悪なように思える。
一方、1.のマッチングは比較的良さそう。
3.のマッチングはどうだろう。

ここで、パーティの内部レートとして、プレイヤーの内部レートの平均を取ってみる。

1. [5, 5, 6]
2. [2, 16, 7]
3. [8, 8, 8]

3.のマッチングは、実は平均を取ると分散が0なので、拮抗した戦いを見られる可能性がある。「分散」とは、散らばり具合を示す量で、ここでは「内部レートが平均に寄っていること」を示す。

それでも感覚的には1.のマッチングが最適のように思える。それもそうで、3.のマッチングでは1v1になると圧倒的な差が生まれる組み合わせが存在する。

以上より、「平等なマッチングシステム」を作る上で、次の理念が考えられる

1. マッチングに参加するプレイヤー間の内部レートの最大の差ができるだけ小さいこと
2. マッチングに参加するパーティの内部レートの分散ができるだけ小さいこと(全パーティの内部レートが平均にできるだけ近いこと)

### 用語の整理

ここでは、ロジックを説明する上で、開発運営に携わる人の間で通じる共通の用語を定義・整理する。

* プレイヤーの内部レート: プレイヤーの実力を示す指標のこと。平等なマッチングを行う際に利用する。現時点では、ポイントを利用する
* パーティの内部レート: パーティの実力を示す指標のこと。現時点ではプレイヤーの内部レートの平均。
* エントリー: マッチング待ちのグループの単位。ソロ、デュオ、トリオ。Apexのランクやカジュアルでいうところの、ロビーでマッチ検索のボタンを押したときに送られるパーティの情報。
* エントリーの内部レート: エントリーの実力を示す指標のこと。平等なマッチングを行う際に利用する。現時点ではプレイヤーの内部レートの平均。
* ソート: 並び替えること。特に明記が無い限り、「昇順への並び替え」とする。

### エントリー間の内部レートの最大の差をできるだけ小さくする方法

理念1「マッチングに参加するプレイヤー間の内部レートの最大の差ができるだけ小さいこと」を実現する上で、デュオやトリオでの参加を考慮する場合は、「プレイヤー間」を、「エントリー間」に置き換えて考える。

例えば、下記のようなエントリーのリストでは、実力差はあるが、デュオを剥がすわけにもいかないので、エントリーの内部レートを計算し、その差をできるだけ小さくすることで理念1を実現する。

[[4, 12], [8], [8], [8], [8], [16, 2], [6]]

#### 具体的な方法

単純な例としてトリオでのエントリーの内部レートを考える。ここでも4パーティで1マッチとする。下記はエントリー内部レートのリストである。

[4, 3, 9, 7, 8, 6, 11, 10, 2, 5, 1, 12]

単純に前からマッチを作ってみよう。

[4, 3, 9, 7], [8, 6, 11, 10], [2, 5, 1, 12]

これだとそれぞれ内部レートの最大の差は、

6, 5, 10となり、実力差が開いているので良くない。

上記のようなエントリーで理念1を実現するにはエントリーをソートする。

[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

この状態で前からマッチを作る

[1, 2, 3, 4], [5, 6, 7, 8], [9, 10, 11, 12]

内部レートの最大の差は 3, 3, 3 となり、これ以上小さくすることはできない。

よって、エントリーをソートすることで、理念1が実現できた

### パーティの内部レートの分散をできるだけ小さくする方法

上記の方法で理念1を実現しても、エントリーの組み合わせによってはパーティ間で実力差が出てくる可能性が存在する。その理由を説明する。

まず、エントリー内で、相対的に「弱いデュオ」「強いデュオ」「弱いソロ」「強いソロ」を考えることができる。

この中で「弱いデュオ」と「弱いソロ」を組み合わせると、理念2「パーティの内部レートの分散をできるだけ小さい」ことにすぐ違反する。

よって、「弱いデュオ」と「強いソロ」、「強いデュオ」と「弱いソロ」を組み合わせるアプローチによって、分散を小さくするパーティのマッチングを考える。

そのロジックを下記に述べる。

#### 1. 事前準備

1. マッチに参加するエントリーの内部レートの中央値を計算する。
3. エントリーより、ソロとデュオを抽出する。

#### 2. デュオマッチング

デュオにソロを割り当てるロジック。ここでは「デュオマッチング」と呼ぶ。

事前準備で抽出したデュオについて、中央値との偏差が大きいものを順に取り出し、下記を行う。

1. デュオの内部レートが中央値より低い場合、内部レートが1番高いソロをそこに割り当てる。
2. デュオの内部レートが中央値より高い場合、内部レートが1番低いソロをそこに割り当てる。

ソロが余った場合はそのまま次の処理に持っていく。

#### 3. ソロマッチング

ソロの集合から3人組を決めるロジック。ここでは「ソロマッチング」と呼ぶ。

事前準備で抽出したソロを内部レート順に並び替え、3分割する。

例:

[3, 3, 3, 4, 4, 5, 5, 6, 6, 6, 6, 6, 7, 8] 14人。1グループ4人。

低いグループ: [3, 3, 3, 4] (昇順に並び替える)

高いグループ: [8, 7, 6, 6] (降順に並び替える)

真ん中のグループ: [4, 5, 5, 6] [6, 6] (真ん中のグループのうち、はみ出した強いソロ最大二人は、それらをパーティとする)

低いグループと高いグループについて、それぞれ先頭から順に1人ずつ選び、デュオを作っていく。

[3, 8], [3, 7], [3, 6], [4, 6]

作り出したデュオと真ん中のグループのソロで、上記「デュオマッチング」を行う。

#### 4. まとめる

エントリーしたトリオ、2で作ったトリオ、3で作ったトリオをくっつける。

#### ロジックの実行結果

以上のようなロジックによって、分散の低いパーティを作ることができた。

下記はテストの実行結果

```
tests/domain/test_matching.py::test_solo_matching [(4, 4, 6), (3, 4, 7), (3, 5, 7), (3, 6, 7), (6, 6)]
分散: before:2.2091836734693873, after0.24888888888888877
PASSED
tests/domain/test_matching.py::test_duo_matching [(2, 2, 5), (2, 4, 2), (3, 3, 2), (3,)]
分散: before:0.9795918367346939, after0.027777777777777804
PASSED
tests/domain/test_matching.py::test_matching [(2, 2, 7), (2, 4, 7), (3, 3, 7), (4, 4, 2), (5, 6, 2), (3, 3, 6), (3, 4, 6), (3, 5, 6)]
分散: before:3.087257617728531, after0.16493055555555552
PASSED
```
